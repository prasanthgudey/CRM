@using CRM.Client.DTOs.Customers
@using CRM.Client.DTOs.Users
@using CRM.Client.Services.Customers
@using CRM.Client.Services.Users

@inject CustomerService CustomerService
@inject UserService UserService

@if (IsOpen && Customer != null)
{
    <div class="modal fade show d-block customer-modal-backdrop" tabindex="-1">
        <div class="modal-dialog modal-lg modal-dialog-centered customer-modal-dialog">
            <div class="modal-content customer-modal-content">
                <div class="modal-header customer-modal-header">
                    <h5 class="modal-title customer-modal-title">
                        🧑‍💼 Edit Customer - @Customer.FullName
                    </h5>
                    <button type="button" class="btn-close btn-close-white"
                            @onclick="() => Close(false)"></button>
                </div>

                <div class="modal-body customer-modal-body">
                    <EditForm Model="@Model" OnValidSubmit="HandleValidSubmit">
                        <DataAnnotationsValidator />
                        <ValidationSummary />

                        <div class="customer-section mb-3">
                            <div class="customer-section-title">Name</div>
                            <div class="row g-3">
                                <div class="col-md-4">
                                    <label class="form-label">First Name</label>
                                    <InputText class="form-control"
                                               @bind-Value="Model.FirstName" />
                                </div>

                                <div class="col-md-4">
                                    <label class="form-label">Middle Name</label>
                                    <InputText class="form-control"
                                               @bind-Value="Model.MiddleName" />
                                </div>

                                <div class="col-md-4">
                                    <label class="form-label">Surname</label>
                                    <InputText class="form-control"
                                               @bind-Value="Model.SurName" />
                                </div>
                            </div>

                            <div class="mt-3">
                                <label class="form-label">Preferred Name</label>
                                <InputText class="form-control"
                                           @bind-Value="Model.PreferredName" />
                            </div>
                        </div>

                        <div class="customer-section mb-3">
                            <div class="customer-section-title">Contact</div>
                            <div class="row g-3">
                                <div class="col-md-6">
                                    <label class="form-label">Email</label>
                                    <InputText class="form-control"
                                               @bind-Value="Model.Email" />
                                </div>

                                <div class="col-md-6">
                                    <label class="form-label">Phone</label>
                                    <InputText class="form-control"
                                               @bind-Value="Model.Phone" />
                                </div>
                            </div>
                        </div>

                        <div class="customer-section mb-3">
                            <div class="customer-section-title">Address</div>
                            <div>
                                <label class="form-label">Address</label>
                                <InputTextArea class="form-control"
                                               rows="3"
                                               @bind-Value="Model.Address" />
                            </div>
                        </div>

                        <div class="customer-section mb-1">
                            <div class="customer-section-title">Meta</div>

                            <div class="row g-3">
                                <div class="col-md-6">
                                    <label class="form-label">Created By</label>
                                    <input class="form-control"
                                           value="@_createdByDisplay"
                                           disabled />
                                </div>

                                <div class="col-md-6">
                                    <label class="form-label">Created At</label>
                                    <input class="form-control"
                                           value="@Customer.CreatedAt"
                                           disabled />
                                </div>
                            </div>
                        </div>
                    </EditForm>
                </div>

                <div class="modal-footer customer-modal-footer">
                    <button type="button"
                            class="btn btn-outline-secondary"
                            @onclick="() => Close(false)">
                        Cancel
                    </button>
                    <button type="button"
                            class="btn btn-primary"
                            @onclick="Submit">
                        Save Changes
                    </button>
                </div>
            </div>
        </div>
    </div>
}

@code {
    [Parameter] public bool IsOpen { get; set; }
    [Parameter] public CustomerResponseDto? Customer { get; set; }
    [Parameter] public EventCallback<bool> OnClose { get; set; }

    private CustomerUpdateDto Model { get; set; } = new();

    private List<UserResponseDto>? _users;
    private string _createdByDisplay = string.Empty;

    protected override async Task OnParametersSetAsync()
    {
        if (IsOpen && Customer != null)
        {
            // Map customer → update model
            Model = new CustomerUpdateDto
            {
                FirstName = Customer.FirstName,
                SurName = Customer.SurName,
                MiddleName = Customer.MiddleName,
                PreferredName = Customer.PreferredName,
                Email = Customer.Email,
                Phone = Customer.Phone,
                Address = Customer.Address
            };

            // Load users once
            if (_users == null)
            {
                _users = await UserService.GetAllUsersAsync();
            }

            // Build "Created By" display text
            _createdByDisplay = Customer.CreatedByUserId.ToString();

            if (_users != null)
            {
                var user = _users.FirstOrDefault(u =>
                    u.Id.ToString().Equals(Customer.CreatedByUserId.ToString(), StringComparison.OrdinalIgnoreCase));

                if (user != null)
                {
                    var name = string.IsNullOrWhiteSpace(user.FullName)
                        ? user.Email
                        : user.FullName;

                    _createdByDisplay = $"{name} ({user.Email})";
                }
            }
        }
    }

    private async Task HandleValidSubmit()
    {
        if (Customer == null) return;

        await CustomerService.UpdateAsync(Customer.CustomerId, Model);
        await Close(true);
    }

    private async Task Submit()
    {
        await HandleValidSubmit();
    }

    private async Task Close(bool refresh)
    {
        await OnClose.InvokeAsync(refresh);
    }
}
