@using CRM.Client.DTOs.Customers
@using CRM.Client.DTOs.Users
@using CRM.Client.Services.Customers
@using CRM.Client.Services.Users
@using Microsoft.AspNetCore.Components.Forms

@inject CustomerService CustomerService
@inject UserService UserService
@inject IJSRuntime JSRuntime

@if (IsOpen && Customer != null)
{
    <div class="modal fade show d-block customer-modal-backdrop" tabindex="-1">
        <div class="modal-dialog modal-lg modal-dialog-centered customer-modal-dialog">
            <div class="modal-content customer-modal-content">

                <!-- HEADER -->
                <div class="modal-header customer-modal-header">
                    <h5 class="modal-title customer-modal-title">
                        🧑‍💼 Edit Customer - @Customer.FullName
                    </h5>
                    <button type="button"
                            class="btn-close btn-close-white"
                            @onclick="() => Close(false)">
                    </button>
                </div>

                <!-- BODY -->
                <div class="modal-body customer-modal-body">
                    <EditForm EditContext="@editContext" OnValidSubmit="HandleValidSubmit">
                        <DataAnnotationsValidator />

                        <!-- NAME -->
                        <div class="customer-section mb-3">
                            <div class="customer-section-title">Name</div>

                            <div class="row g-3">
                                <div class="col-md-4">
                                    <label class="form-label">First Name</label>
                                    <InputText class="form-control"
                                               @bind-Value="Model.FirstName" />
                                    <ValidationMessage For="@(() => Model.FirstName)" />
                                </div>

                                <div class="col-md-4">
                                    <label class="form-label">Middle Name</label>
                                    <InputText class="form-control" @bind-Value="Model.MiddleName" />
                                </div>

                                <div class="col-md-4">
                                    <label class="form-label">Surname</label>
                                    <InputText class="form-control"
                                               @bind-Value="Model.SurName" />
                                    <ValidationMessage For="@(() => Model.SurName)" />
                                </div>
                            </div>

                            <div class="mt-3">
                                <label class="form-label">Preferred Name</label>
                                <InputText class="form-control" @bind-Value="Model.PreferredName" />
                            </div>
                        </div>

                        <!-- CONTACT -->
                        <div class="customer-section mb-3">
                            <div class="customer-section-title">Contact</div>

                            <div class="row g-3">
                                <div class="col-md-6">
                                    <label class="form-label">Email</label>
                                    <InputText class="form-control"
                                               @bind-Value="Model.Email" />
                                    <ValidationMessage For="@(() => Model.Email)" />
                                </div>

                                <div class="col-md-6">
                                    <label class="form-label">Phone</label>
                                    <InputText class="form-control"
                                               @bind-Value="Model.Phone" />
                                    <ValidationMessage For="@(() => Model.Phone)" />
                                </div>
                            </div>
                        </div>

                        <!-- ADDRESS -->
                        <div class="customer-section mb-3">
                            <div class="customer-section-title">Address</div>
                            <label class="form-label">Address</label>
                            <InputTextArea class="form-control"
                                           rows="3"
                                           @bind-Value="Model.Address" />
                            <ValidationMessage For="@(() => Model.Address)" />
                        </div>

                        <!-- META -->
                        <div class="customer-section mb-1">
                            <div class="customer-section-title">Meta</div>

                            <div class="row g-3">
                                <div class="col-md-6">
                                    <label class="form-label">Created By</label>
                                    <input class="form-control"
                                           value="@_createdByDisplay"
                                           disabled />
                                </div>

                                <div class="col-md-6">
                                    <label class="form-label">Created At</label>
                                    <input class="form-control"
                                           value="@Customer.CreatedAt"
                                           disabled />
                                </div>
                            </div>
                        </div>
                    </EditForm>
                </div>

                <!-- FOOTER -->
                <div class="modal-footer customer-modal-footer">
                    <button type="button"
                            class="btn btn-outline-secondary"
                            @onclick="() => Close(false)">
                        Cancel
                    </button>

                    <button type="button"
                            class="btn btn-primary"
                            disabled="@IsLoading"
                            @onclick="Submit">
                        @(IsLoading ? "Saving..." : "Save Changes")
                    </button>
                </div>

            </div>
        </div>
    </div>
}

@code {
    [Parameter] public bool IsOpen { get; set; }
    [Parameter] public CustomerResponseDto? Customer { get; set; }
    [Parameter] public EventCallback<bool> OnClose { get; set; }

    private CustomerUpdateDto Model { get; set; } = new();
    private List<CustomerResponseDto>? ExistingCustomers;

    private List<UserResponseDto>? _users;
    private string _createdByDisplay = string.Empty;

    private bool IsLoading;

    private EditContext? editContext;
    private ValidationMessageStore? messageStore;

    protected override async Task OnParametersSetAsync()
    {
        if (IsOpen && Customer != null)
        {
            Model = new CustomerUpdateDto
            {
                FirstName = Customer.FirstName,
                SurName = Customer.SurName,
                MiddleName = Customer.MiddleName,
                PreferredName = Customer.PreferredName,
                Email = Customer.Email,
                Phone = Customer.Phone,
                Address = Customer.Address
            };

            editContext = new EditContext(Model);
            messageStore = new ValidationMessageStore(editContext);

            editContext.OnFieldChanged += HandleFieldChanged;

            ExistingCustomers = await CustomerService.GetAllAsync();

            if (_users == null)
                _users = await UserService.GetAllUsersAsync();

            BuildCreatedByDisplay();
        }
    }

    private void HandleFieldChanged(object? sender, FieldChangedEventArgs e)
    {
        if (e.FieldIdentifier.FieldName == nameof(Model.Email))
        {
            messageStore?.Clear(e.FieldIdentifier);
            editContext?.NotifyValidationStateChanged();
        }
    }

    private void BuildCreatedByDisplay()
    {
        _createdByDisplay = Customer?.CreatedByUserId.ToString() ?? "";

        if (_users != null && Customer != null)
        {
            var user = _users.FirstOrDefault(u =>
                u.Id.ToString().Equals(Customer.CreatedByUserId.ToString(), StringComparison.OrdinalIgnoreCase));

            if (user != null)
            {
                var name = string.IsNullOrWhiteSpace(user.FullName)
                    ? user.Email
                    : user.FullName;

                _createdByDisplay = $"{name} ({user.Email})";
            }
        }
    }

    private async Task HandleValidSubmit()
    {
        if (Customer == null) return;

        messageStore?.Clear();

        // ★ DUPLICATE EMAIL VALIDATION ★
        if (!string.IsNullOrWhiteSpace(Model.Email) && ExistingCustomers != null)
        {
            bool exists = ExistingCustomers.Any(c =>
                !string.IsNullOrWhiteSpace(c.Email) &&
                c.Email.ToLower() == Model.Email.ToLower() &&
                c.CustomerId != Customer.CustomerId);

            if (exists)
            {
                messageStore?.Add(() => Model.Email, "Email already exists.");
                editContext?.NotifyValidationStateChanged();
                return;
            }
        }

        await SaveAsync();
    }

    private async Task Submit() => await HandleValidSubmit();

    private async Task SaveAsync()
    {
        IsLoading = true;

        try
        {
            await CustomerService.UpdateAsync(Customer.CustomerId, Model);

            await JSRuntime.InvokeVoidAsync("Swal.fire",
                "Success",
                "Customer updated successfully",
                "success");

            await Close(true);
        }
        catch
        {
            await JSRuntime.InvokeVoidAsync("Swal.fire",
                "Error",
                "Failed to update customer",
                "error");
        }
        finally
        {
            IsLoading = false;
        }
    }

    private async Task Close(bool refresh)
    {
        await OnClose.InvokeAsync(refresh);
    }
}
