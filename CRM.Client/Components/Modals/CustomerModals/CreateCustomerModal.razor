@using CRM.Client.DTOs.Customers
@using CRM.Client.DTOs.Users
@using CRM.Client.Services.Customers
@using CRM.Client.Services.Users
@using Microsoft.AspNetCore.Components.Authorization
@using System.Security.Claims
@using Microsoft.AspNetCore.Components.Forms

@inject CustomerService CustomerService
@inject UserService UserService
@inject AuthenticationStateProvider AuthenticationStateProvider
@inject IJSRuntime JSRuntime

@if (IsOpen)
{
    <div class="modal fade show d-block customer-modal-backdrop" tabindex="-1">
        <div class="modal-dialog modal-lg modal-dialog-centered customer-modal-dialog">
            <div class="modal-content customer-modal-content">

                <!-- HEADER -->
                <div class="modal-header customer-modal-header">
                    <h5 class="modal-title customer-modal-title">🧑‍💼 Create Customer</h5>
                    <button type="button"
                            class="btn-close btn-close-white"
                            @onclick="() => Close(false)">
                    </button>
                </div>

                <!-- BODY -->
                <div class="modal-body customer-modal-body">

                    <EditForm Model="@Model" OnValidSubmit="HandleValidSubmit">
                        <DataAnnotationsValidator />

                        <!-- NAME -->
                        <div class="customer-section mb-3">
                            <div class="customer-section-title">Name</div>

                            <div class="row g-3">
                                <div class="col-md-4">
                                    <label class="form-label">First Name</label>
                                    <InputText class="form-control" @bind-Value="Model.FirstName" />
                                    <ValidationMessage For="@(() => Model.FirstName)" class="text-danger" />
                                </div>

                                <div class="col-md-4">
                                    <label class="form-label">Middle Name</label>
                                    <InputText class="form-control" @bind-Value="Model.MiddleName" />
                                </div>

                                <div class="col-md-4">
                                    <label class="form-label">Surname</label>
                                    <InputText class="form-control" @bind-Value="Model.SurName" />
                                    <ValidationMessage For="@(() => Model.SurName)" class="text-danger" />
                                </div>
                            </div>

                            <div class="mt-3">
                                <label class="form-label">Preferred Name</label>
                                <InputText class="form-control" @bind-Value="Model.PreferredName" />
                            </div>
                        </div>

                        <!-- CONTACT -->
                        <div class="customer-section mb-3">
                            <div class="customer-section-title">Contact</div>

                            <div class="row g-3">
                                <div class="col-md-6">
                                    <label class="form-label">Email</label>
                                    <InputText class="form-control" @bind-Value="Model.Email" />
                                    <ValidationMessage For="@(() => Model.Email)" class="text-danger" />
                                </div>

                                <div class="col-md-6">
                                    <label class="form-label">Phone</label>
                                    <InputText class="form-control"
                                               @bind-Value="Model.Phone"
                                               maxlength="10"
                                               inputmode="numeric"
                                               />

                                    <ValidationMessage For="@(() => Model.Phone)" class="text-danger" />
                                </div>
                            </div>
                        </div>

                        <!-- ADDRESS -->
                        <div class="customer-section mb-3">
                            <div class="customer-section-title">Address</div>

                            <InputTextArea class="form-control" rows="3" @bind-Value="Model.Address" />
                            <ValidationMessage For="@(() => Model.Address)" class="text-danger" />
                        </div>

                        <!-- META -->
                        <div class="customer-section mb-2">
                            <div class="customer-section-title">Meta</div>

                            <div class="row g-3 align-items-center">
                                <div class="col-md-8">
                                    <label class="form-label">Created By User</label>

                                    <!-- LOGGED-IN USER (READ ONLY) -->
                                    <InputSelect class="form-select" @bind-Value="SelectedUserId" disabled>
                                        @if (LoggedInUser != null)
                                        {
                                            <option value="@LoggedInUser.Id">
                                                @LoggedInUserLabel
                                            </option>
                                        }
                                    </InputSelect>
                                </div>
                            </div>
                        </div>

                        <button type="submit"
                                class="btn btn-success w-100 mt-3"
                                disabled="@IsLoading">
                            @(IsLoading ? "Saving..." : "Save Customer")
                        </button>

                    </EditForm>
                </div>

                <!-- FOOTER -->
                <div class="modal-footer customer-modal-footer">
                    <button class="btn btn-outline-secondary"
                            @onclick="() => Close(false)">
                        Cancel
                    </button>
                </div>

            </div>
        </div>
    </div>
}

@code {
    [Parameter] public bool IsOpen { get; set; }
    [Parameter] public EventCallback<bool> OnClose { get; set; }

    private CustomerCreateDto Model { get; set; } = new();
    private List<UserResponseDto>? Users;

    private UserResponseDto? LoggedInUser;
    private string? SelectedUserId;
    private bool IsLoading;

    private string LoggedInUserLabel =>
        string.IsNullOrWhiteSpace(LoggedInUser?.FullName)
            ? LoggedInUser?.Email ?? ""
            : $"{LoggedInUser.FullName} ({LoggedInUser.Email})";

    private bool _lookupsLoaded;

    protected override async Task OnParametersSetAsync()
    {
        if (IsOpen && !_lookupsLoaded)
        {
            await LoadLoggedInUser();
            _lookupsLoaded = true;
        }
    }

    private async Task LoadLoggedInUser()
    {
        Users = await UserService.GetAllUsersAsync();

        var auth = await AuthenticationStateProvider.GetAuthenticationStateAsync();
        var user = auth.User;

        var userId = user.FindFirst(ClaimTypes.NameIdentifier)?.Value
                  ?? user.FindFirst("sub")?.Value;

        var email = user.FindFirst(ClaimTypes.Email)?.Value;

        LoggedInUser = Users?.FirstOrDefault(u => u.Id == userId)
                    ?? Users?.FirstOrDefault(u => u.Email == email);

        if (LoggedInUser != null)
        {
            SelectedUserId = LoggedInUser.Id;

            if (Guid.TryParse(LoggedInUser.Id, out var uid))
                Model.CreatedByUserId = uid;
        }
    }

    private async Task HandleValidSubmit()
    {
        if (Guid.TryParse(SelectedUserId, out var uid))
            Model.CreatedByUserId = uid;

        IsLoading = true;

        try
        {
            await CustomerService.CreateAsync(Model);

            // ✅ API returns no body → success if no exception
            await JSRuntime.InvokeVoidAsync("Swal.fire",
                "Success",
                "Customer created successfully",
                "success");

            await Close(true);
        }
        catch
        {
            await JSRuntime.InvokeVoidAsync("Swal.fire",
                "Error",
                "Failed to create customer",
                "error");
        }
        finally
        {
            IsLoading = false;
        }
    }

    private async Task Close(bool refresh)
    {
        Model = new CustomerCreateDto();
        await OnClose.InvokeAsync(refresh);
    }
}
