@using CRM.Client.DTOs.Tasks

@if (IsOpen && Model != null)
{
    <div class="modal fade show d-block" tabindex="-1" style="background-color: rgba(0,0,0,0.35);">
        <div class="modal-dialog modal-lg modal-dialog-centered">
            <div class="modal-content">

                <div class="modal-header" style="background:#0d6efd;color:white;">
                    <h5 class="modal-title">Task — View</h5>
                    <button type="button" class="btn-close btn-close-white" @onclick="Close"></button>
                </div>

                <div class="modal-body" style="padding:18px;">

                    <!-- BASIC INFO -->
                    <div class="mb-3">
                        <div class="fw-bold mb-2">Basic Info</div>

                        <div class="row g-3">
                            <div class="col-12">
                                <label class="form-label">Title</label>
                                <div class="form-control-plaintext">@Model.Title</div>
                            </div>

                            <div class="col-12">
                                <label class="form-label">Description</label>
                                <div class="form-control-plaintext">@DisplayOrDash(Model.Description)</div>
                            </div>
                        </div>
                    </div>

                    <!-- ASSIGNMENT -->
                    <div class="mb-3">
                        <div class="fw-bold mb-2">Assignment</div>

                        <div class="row g-3">
                            <div class="col-md-6">
                                <label class="form-label">Customer ID</label>
                                <div class="form-control-plaintext">@Model.CustomerId</div>
                            </div>

                            <div class="col-md-6">
                                <label class="form-label">Assigned User ID</label>
                                <div class="form-control-plaintext">@Model.UserId</div>
                            </div>
                        </div>
                    </div>

                    <!-- STATUS -->
                    <div class="mb-3">
                        <div class="fw-bold mb-2">Status</div>

                        <div class="row g-3">
                            <div class="col-md-4">
                                <label class="form-label">State</label>

                                <!-- GREEN WHEN COMPLETED -->
                                <div class="form-control-plaintext @(Model.State == TaskState.Completed ? "task-completed" : "")">
                                    @Model.State
                                </div>
                            </div>

                            <div class="col-md-4">
                                <label class="form-label">Priority</label>
                                <div class="form-control-plaintext">@Model.Priority</div>
                            </div>

                            <div class="col-md-4">
                                <label class="form-label">Due Date</label>

                                <!-- NO RED COLOR ANYMORE -->
                                <div class="form-control-plaintext">
                                    @FormatDate(Model.DueDate)
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- TIMESTAMPS -->
                    <div class="mb-3">
                        <div class="fw-bold mb-2">Timestamps</div>

                        <div class="row g-3">
                            <div class="col-md-6">
                                <label class="form-label">Created At</label>
                                <div class="form-control-plaintext">@FormatDate(Model.CreatedAt)</div>
                            </div>

                            <div class="col-md-6">
                                <label class="form-label">Completed At</label>
                                <div class="form-control-plaintext">@FormatNullable(Model.CompletedAt)</div>
                            </div>
                        </div>
                    </div>

                    <!-- RECURRENCE -->
                    <div class="mb-3">
                        <div class="fw-bold mb-2">Recurrence</div>

                        <div class="row g-3">
                            <div class="col-md-4">
                                <label class="form-label">Is Recurring</label>
                                <div class="form-control-plaintext">@Model.IsRecurring</div>
                            </div>

                            <div class="col-md-4">
                                <label class="form-label">Recurrence Type</label>
                                <div class="form-control-plaintext">@Model.RecurrenceType</div>
                            </div>

                            <div class="col-md-4">
                                <label class="form-label">Recurrence Interval</label>
                                <div class="form-control-plaintext">@DisplayOrDash(Model.RecurrenceInterval?.ToString())</div>
                            </div>

                            <div class="col-md-12">
                                <label class="form-label">Recurrence End Date</label>
                                <div class="form-control-plaintext">@FormatNullable(Model.RecurrenceEndDate)</div>
                            </div>
                        </div>
                    </div>

                </div>

                <div class="modal-footer" style="background:#f8f9fa;">
                    <button type="button" class="btn btn-outline-secondary" @onclick="Close">Close</button>
                </div>

            </div>
        </div>
    </div>
}

@code {
    [Parameter] public bool IsOpen { get; set; }
    [Parameter] public EventCallback<bool> OnClose { get; set; }
    [Parameter] public TaskResponseDto? Model { get; set; }

    private async Task Close() => await OnClose.InvokeAsync(false);

    private static string DisplayOrDash(string? value) =>
        string.IsNullOrWhiteSpace(value) ? "-" : value!;

    private static string FormatDate(DateTime date) =>
        date.ToLocalTime().ToString("dd MMM yyyy HH:mm");

    private static string FormatNullable(DateTime? date) =>
        date.HasValue ? date.Value.ToLocalTime().ToString("dd MMM yyyy HH:mm") : "-";
}
