@using CRM.Client.DTOs.Tasks
@using CRM.Client.DTOs.Customers
@using CRM.Client.DTOs.Users
@using CRM.Client.Services.Tasks
@using CRM.Client.Services.Customers
@using CRM.Client.Services.Users

@inject IJSRuntime JSRuntime
@inject TaskService TaskService
@inject CustomerService CustomerService
@inject UserService UserService

@if (IsOpen && Task != null)
{
    <div class="modal fade show d-block"
         tabindex="-1"
         style="background-color: rgba(0,0,0,0.5);">
        <div class="modal-dialog modal-lg modal-dialog-centered">
            <div class="modal-content">

                <!-- HEADER -->
                <div class="modal-header">
                    <h5 class="modal-title">Edit Task - @Task.Title</h5>
                    <button type="button"
                            class="btn-close"
                            @onclick="() => Close(false)">
                    </button>
                </div>

                <!-- BODY -->
                <div class="modal-body">
                    <EditForm Model="@Model" OnValidSubmit="HandleValidSubmit">
                        <DataAnnotationsValidator />
                        <ValidationSummary />

                        <div class="row mb-3">
                            <div class="col-md-6">
                                <label class="form-label">Customer</label>
                                <InputSelect class="form-select"
                                             @bind-Value="SelectedCustomerIdString">
                                    <option value="">-- Select customer --</option>
                                    @foreach (var c in Customers ?? new())
                                    {
                                        <option value="@c.CustomerId.ToString()">
                                            @c.FullName (@c.Email)
                                        </option>
                                    }
                                </InputSelect>
                            </div>

                            <div class="col-md-6">
                                <label class="form-label">User</label>
                                <InputSelect class="form-select"
                                             @bind-Value="SelectedUserId">
                                    <option value="">-- Assign to user --</option>
                                    @foreach (var u in Users ?? new())
                                    {
                                        var display = string.IsNullOrWhiteSpace(u.FullName)
                                        ? u.Email
                                        : $"{u.FullName} ({u.Email})";

                                        <option value="@u.Id">@display</option>
                                    }
                                </InputSelect>
                            </div>
                        </div>

                        <label class="form-label">Title</label>
                        <InputText class="form-control" @bind-Value="Model.Title" />

                        <label class="form-label mt-2">Description</label>
                        <InputTextArea class="form-control" @bind-Value="Model.Description" />

                        <label class="form-label mt-2">Due Date</label>
                        <InputDate class="form-control" @bind-Value="Model.DueDate" />

                        <label class="form-label mt-2">Priority</label>
                        <InputSelect class="form-select" @bind-Value="Model.Priority">
                            @foreach (var v in Enum.GetValues<TaskPriority>())
                            {
                                <option value="@v">@v</option>
                            }
                        </InputSelect>

                        <label class="form-label mt-2">State</label>
                        <InputSelect class="form-select" @bind-Value="Model.State">
                            @foreach (var v in Enum.GetValues<TaskState>())
                            {
                                <option value="@v">@v</option>
                            }
                        </InputSelect>

                        <div class="form-check mt-3">
                            <InputCheckbox class="form-check-input"
                                           @bind-Value="Model.IsRecurring" />
                            <label class="form-check-label">Is Recurring</label>
                        </div>

                        @if (Model.IsRecurring)
                        {
                            <label class="form-label mt-2">Recurrence Type</label>
                            <InputSelect class="form-select"
                                         @bind-Value="Model.RecurrenceType">
                                @foreach (var v in Enum.GetValues<RecurrenceType>())
                                {
                                    <option value="@v">@v</option>
                                }
                            </InputSelect>

                            <label class="form-label mt-2">Interval</label>
                            <InputNumber class="form-control"
                                         @bind-Value="Model.RecurrenceInterval" />

                            <label class="form-label mt-2">End Date</label>
                            <InputDate class="form-control"
                                       @bind-Value="Model.RecurrenceEndDate" />
                        }
                    </EditForm>
                </div>

                <!-- FOOTER -->
                <div class="modal-footer">
                    <button class="btn btn-secondary"
                            @onclick="() => Close(false)">
                        Cancel
                    </button>

                    <button class="btn btn-primary"
                            disabled="@IsLoading"
                            @onclick="Submit">
                        @(IsLoading ? "Saving..." : "Save Changes")
                    </button>
                </div>
            </div>
        </div>
    </div>
}

@code {
    [Parameter] public bool IsOpen { get; set; }
    [Parameter] public TaskResponseDto? Task { get; set; }
    [Parameter] public EventCallback<bool> OnClose { get; set; }

    private UpdateTaskDto Model = new();
    private List<CustomerResponseDto>? Customers;
    private List<UserResponseDto>? Users;

    private string? SelectedCustomerIdString;
    private string? SelectedUserId;
    private bool IsLoading;

    protected override async Task OnParametersSetAsync()
    {
        if (!IsOpen || Task == null) return;

        Customers ??= await CustomerService.GetAllAsync();
        Users ??= await UserService.GetAllUsersAsync();

        Model = new UpdateTaskDto
        {
            Title = Task.Title,
            Description = Task.Description,
            DueDate = Task.DueDate,
            Priority = Task.Priority,
            State = Task.State,
            IsRecurring = Task.IsRecurring,
            RecurrenceType = Task.RecurrenceType,
            RecurrenceInterval = Task.RecurrenceInterval,
            RecurrenceEndDate = Task.RecurrenceEndDate
        };

        SelectedCustomerIdString = Task.CustomerId.ToString();
        SelectedUserId = Task.UserId;
    }

    private async Task HandleValidSubmit()
    {
        if (Task == null) return;

        IsLoading = true;

        try
        {
            await TaskService.UpdateAsync(Task.TaskId, Model);

            await JSRuntime.InvokeVoidAsync("Swal.fire",
                "Success",
                "Task updated successfully",
                "success");

            await Close(true);
        }
        catch
        {
            await JSRuntime.InvokeVoidAsync("Swal.fire",
                "Error",
                "Failed to update task",
                "error");
        }
        finally
        {
            IsLoading = false;
        }
    }

    private async Task Submit() => await HandleValidSubmit();

    private async Task Close(bool refresh)
        => await OnClose.InvokeAsync(refresh);
}
