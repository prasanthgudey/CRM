@using CRM.Client.DTOs.Tasks
@using CRM.Client.DTOs.Customers
@using CRM.Client.DTOs.Users
@using CRM.Client.Services.Tasks
@using CRM.Client.Services.Customers
@using CRM.Client.Services.Users

@inject TaskService TaskService
@inject CustomerService CustomerService
@inject UserService UserService

@if (IsOpen)
{
    <div class="modal fade show d-block task-modal-backdrop" tabindex="-1">
        <div class="modal-dialog modal-lg modal-dialog-centered task-modal-dialog">
            <div class="modal-content task-modal-content">
                <div class="modal-header task-modal-header">
                    <h5 class="modal-title task-modal-title">
                        <span class="task-modal-icon">🗂️</span>
                        Create Task
                    </h5>
                    <button type="button" class="btn-close btn-close-white"
                            @onclick="() => Close(false)"></button>
                </div>

                <div class="modal-body task-modal-body">
                    <EditForm Model="@Model" OnValidSubmit="HandleValidSubmit">
                        <DataAnnotationsValidator />
                        <ValidationSummary />

                        <div class="task-section mb-3">
                            <div class="task-section-title">Assignment</div>
                            <div class="row g-3">
                                <div class="col-md-6">
                                    <label class="form-label">Customer</label>
                                    <InputSelect class="form-select"
                                                 @bind-Value="SelectedCustomerIdString">
                                        <option value="">-- Select customer --</option>
                                        @if (Customers is not null)
                                        {
                                            @foreach (var customer in Customers)
                                            {
                                                <option value="@customer.CustomerId.ToString()">
                                                    @customer.FullName (@customer.Email)
                                                </option>
                                            }
                                        }
                                    </InputSelect>
                                </div>

                                <div class="col-md-6">
                                    <label class="form-label">User</label>
                                    <InputSelect class="form-select"
                                                 @bind-Value="SelectedUserId">
                                        <option value="">-- Assign to user --</option>
                                        @if (Users is not null)
                                        {
                                            @foreach (var user in Users)
                                            {
                                                var display = string.IsNullOrWhiteSpace(user.FullName)
                                                ? user.Email
                                                : $"{user.FullName} ({user.Email})";

                                                <option value="@user.Id">@display</option>
                                            }
                                        }
                                    </InputSelect>
                                </div>
                            </div>
                        </div>

                        <div class="task-section mb-3">
                            <div class="task-section-title">Details</div>
                            <div class="row g-3">
                                <div class="col-12">
                                    <label class="form-label">Title</label>
                                    <InputText class="form-control"
                                               @bind-Value="Model.Title" />
                                </div>

                                <div class="col-12">
                                    <label class="form-label">Description</label>
                                    <InputTextArea class="form-control"
                                                   rows="3"
                                                   @bind-Value="Model.Description" />
                                </div>
                            </div>
                        </div>

                        <div class="task-section mb-3">
                            <div class="task-section-title">Schedule & Priority</div>
                            <div class="row g-3">
                                <div class="col-md-4">
                                    <label class="form-label">Due Date</label>
                                    <InputDate class="form-control"
                                               @bind-Value="Model.DueDate" />
                                </div>

                                <div class="col-md-4">
                                    <label class="form-label">Priority</label>
                                    <InputSelect class="form-select"
                                                 @bind-Value="Model.Priority">
                                        @foreach (var value in Enum.GetValues<TaskPriority>())
                                        {
                                            <option value="@value">@value</option>
                                        }
                                    </InputSelect>
                                </div>

                                <div class="col-md-4">
                                    <label class="form-label">State</label>
                                    <InputSelect class="form-select"
                                                 @bind-Value="Model.State">
                                        @foreach (var value in Enum.GetValues<TaskState>())
                                        {
                                            <option value="@value">@value</option>
                                        }
                                    </InputSelect>
                                </div>
                            </div>
                        </div>

                        <div class="task-section mb-2">
                            <div class="task-section-title d-flex align-items-center justify-content-between">
                                <span>Recurrence</span>
                                <div class="form-check form-switch">
                                    <InputCheckbox class="form-check-input"
                                                   @bind-Value="Model.IsRecurring" />
                                    <label class="form-check-label ms-1">
                                        Is Recurring
                                    </label>
                                </div>
                            </div>

                            @if (Model.IsRecurring)
                            {
                                <div class="row g-3 mt-1">
                                    <div class="col-md-4">
                                        <label class="form-label">Recurrence Type</label>
                                        <InputSelect class="form-select"
                                                     @bind-Value="Model.RecurrenceType">
                                            @foreach (var value in Enum.GetValues<RecurrenceType>())
                                            {
                                                <option value="@value">@value</option>
                                            }
                                        </InputSelect>
                                    </div>

                                    <div class="col-md-4">
                                        <label class="form-label">Recurrence Interval</label>
                                        <InputNumber class="form-control"
                                                     @bind-Value="Model.RecurrenceInterval" />
                                        <small class="text-muted">
                                            Example: 2 = every 2 units of the selected type.
                                        </small>
                                    </div>

                                    <div class="col-md-4">
                                        <label class="form-label">Recurrence End Date</label>
                                        <InputDate class="form-control"
                                                   @bind-Value="Model.RecurrenceEndDate" />
                                    </div>
                                </div>
                            }
                        </div>
                    </EditForm>
                </div>

                <div class="modal-footer task-modal-footer">
                    <button type="button"
                            class="btn btn-outline-secondary"
                            @onclick="() => Close(false)">
                        Cancel
                    </button>
                    <button type="button"
                            class="btn btn-primary"
                            @onclick="Submit">
                        Save Task
                    </button>
                </div>
            </div>
        </div>
    </div>
}

@code {
    [Parameter] public bool IsOpen { get; set; }
    [Parameter] public EventCallback<bool> OnClose { get; set; }

    private CreateTaskDto Model { get; set; } = new();

    private List<CustomerResponseDto>? Customers;
    private List<UserResponseDto>? Users;

    // bound to dropdowns
    private string? SelectedCustomerIdString;
    private string? SelectedUserId;

    private bool _lookupsLoaded;

    protected override async Task OnParametersSetAsync()
    {
        if (IsOpen)
        {
            if (!_lookupsLoaded)
            {
                await LoadLookupsAsync();
                _lookupsLoaded = true;
            }

            // sensible defaults
            if (Model.DueDate == default)
                Model.DueDate = DateTime.Today.AddDays(1);

            if (Model.Priority == 0)
                Model.Priority = TaskPriority.Medium;

            if (Model.State == 0)
                Model.State = TaskState.Pending;

            if (Model.RecurrenceType == 0)
                Model.RecurrenceType = RecurrenceType.None;
        }
    }

    private async Task LoadLookupsAsync()
    {
        Customers = await CustomerService.GetAllAsync();
        Users = await UserService.GetAllUsersAsync();
    }

    private async Task HandleValidSubmit()
    {
        // Validate dropdown selections
        if (!Guid.TryParse(SelectedCustomerIdString, out var customerId))
        {
            // you could add a nicer error message later
            return;
        }

        if (string.IsNullOrWhiteSpace(SelectedUserId))
        {
            return;
        }

        Model.CustomerId = customerId;
        Model.UserId = SelectedUserId;

        await TaskService.CreateAsync(Model);
        await Close(true);
    }

    private async Task Submit()
    {
        await HandleValidSubmit();
    }

    private async Task Close(bool refresh)
    {
        // reset model but keep lookups cached
        Model = new CreateTaskDto
        {
            DueDate = DateTime.Today.AddDays(1),
            Priority = TaskPriority.Medium,
            State = TaskState.Pending,
            RecurrenceType = RecurrenceType.None
        };

        SelectedCustomerIdString = null;
        SelectedUserId = null;

        await OnClose.InvokeAsync(refresh);
    }
}
