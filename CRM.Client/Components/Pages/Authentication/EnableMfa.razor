@page "/enable-mfa"
@layout MainLayout
@attribute [Authorize]
@using Microsoft.AspNetCore.Authorization

@using CRM.Client.Components.Layout
@using CRM.Client.DTOs.Auth
@using CRM.Client.Services.Auth

@inject AuthService AuthService
@inject NavigationManager Navigation

<h3>Enable Multi-Factor Authentication</h3>

@if (IsLoading)
{
    <p>Loading MFA setup...</p>
}
else if (!string.IsNullOrWhiteSpace(ErrorMessage))
{
    <div class="alert alert-danger">@ErrorMessage</div>
}
else if (Response != null)
{
    <div class="card shadow p-3" style="max-width:500px;">

        <div class="mb-3 text-center">
            <label class="form-label fw-bold">Scan this QR in your Authenticator App</label>

            <div class="mt-2">
                <img src="@QrImageUrl"
                     class="img-fluid"
                     style="max-width:260px;" />
            </div>
        </div>

        <div class="mb-3">
            <label class="form-label fw-bold">Manual Setup Key</label>
            <div class="form-control bg-light">
                @Response.SharedKey
            </div>
            <small class="text-muted">
                Use this key if QR scan fails.
            </small>
        </div>

        <div class="mb-3">
            <label class="form-label fw-bold">Enter 6-digit Code</label>
            <input type="text"
                   class="form-control"
                   maxlength="6"
                   placeholder="123456"
                   @bind="Code" />
        </div>

        @if (!string.IsNullOrWhiteSpace(InlineError))
        {
            <div class="alert alert-danger py-2">@InlineError</div>
        }

        <div class="d-flex justify-content-end gap-2">
            <button class="btn btn-secondary"
                    @onclick="Cancel">
                Cancel
            </button>

            <button class="btn btn-primary"
                    disabled="@IsVerifying"
                    @onclick="Verify">
                @(IsVerifying ? "Verifying..." : "Verify & Enable")
            </button>
        </div>

    </div>
}

@code {

    private EnableMfaResponseDto? Response;

    private string QrImageUrl = string.Empty;

    private string Code = string.Empty;

    private bool IsLoading = true;

    private bool IsVerifying;

    private string? ErrorMessage;

    private string? InlineError;   // ⭐ New inline error (for empty or invalid code)


    // Load MFA setup data
    protected override async Task OnInitializedAsync()
    {
        try
        {
            Response = await AuthService.EnableMfaAsync();

            if (Response == null)
            {
                ErrorMessage = "Failed to initialize MFA.";
                return;
            }

            // Convert QR code string to real QR image URL
            QrImageUrl =
                "https://api.qrserver.com/v1/create-qr-code/?size=260x260&data="
                + System.Net.WebUtility.UrlEncode(Response.QrCodeImageUrl);
        }
        catch (Exception ex)
        {
            ErrorMessage = ex.Message;
        }
        finally
        {
            IsLoading = false;
        }
    }


    // Verify user-entered OTP code
    private async Task Verify()
    {
        InlineError = null;
        ErrorMessage = null;

        // ⭐ NEW VALIDATIONS BEFORE CALLING API

        // Empty check
        if (string.IsNullOrWhiteSpace(Code))
        {
            InlineError = "Please enter the 6-digit code.";
            return;
        }

        // Length check
        if (Code.Trim().Length != 6)
        {
            InlineError = "The MFA code must be exactly 6 digits.";
            return;
        }
        if (!Code.All(char.IsDigit))
        {
            InlineError = "The MFA code must contain only numbers.";
            return;
        }

        // Optional digit-only check (enable if needed)
        // if (!Code.All(char.IsDigit))
        // {
        //     InlineError = "The MFA code must contain only numbers.";
        //     return;
        // }

        IsVerifying = true;

        try
        {
            var dto = new VerifyMfaDto { Code = Code.Trim() };

            await AuthService.VerifyMfaAsync(dto);

            // SUCCESS → return to user profile
            Navigation.NavigateTo("/profile", true);
        }
        catch (Exception ex)
        {
            InlineError = ex.Message;  // backend failure
        }
        finally
        {
            IsVerifying = false;
        }
    }

    private void Cancel()
    {
        Navigation.NavigateTo("/profile");
    }

}
