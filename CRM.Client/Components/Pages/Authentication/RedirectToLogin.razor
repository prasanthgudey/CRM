@using Microsoft.AspNetCore.Components.Authorization
@inject AuthenticationStateProvider AuthProvider
@inject NavigationManager Navigation

@code {
    private bool _redirected;

    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        if (!firstRender || _redirected) return;

        try
        {
            var authState = await AuthProvider.GetAuthenticationStateAsync();
            var user = authState.User;

            // If not authenticated -> redirect to login preserving returnUrl
            if (!user.Identity?.IsAuthenticated ?? true)
            {
                var returnUrl = Uri.EscapeDataString(Navigation.Uri);
                _redirected = true;
                Navigation.NavigateTo($"/login?returnUrl={returnUrl}", true);
            }
            // If authenticated but not authorized, do nothing here — App.razor will show Access denied.
        }
        catch
        {
            // If JS interop / provider threw, do nothing here (we're already on client side)
            // Avoid throwing from this component to prevent breaking the UI.
        }
    }
}
