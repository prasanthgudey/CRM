@page "/reset-password"
@attribute [Authorize]
@using Microsoft.AspNetCore.Authorization
@inject NavigationManager Navigation
@inject CRM.Client.Services.Auth.AuthService AuthService

@using Microsoft.AspNetCore.WebUtilities
@using System.ComponentModel.DataAnnotations
@using CRM.Client.DTOs.Auth

<PageTitle>Reset Password</PageTitle>

<div class="d-flex align-items-center justify-content-center" style="min-height:70vh;">
    <div class="card shadow" style="width:420px; border-radius:12px; padding:20px;">
        <h5 class="mb-3 text-center">Reset your password</h5>

        @if (!string.IsNullOrWhiteSpace(PageMessage))
        {
            <div class="alert alert-info py-2">@PageMessage</div>
        }

        <EditForm Model="Model" OnValidSubmit="OnSubmit">
            <DataAnnotationsValidator />
            <ValidationSummary />

            <!-- ✅ EMAIL (READ-ONLY FROM QUERY STRING) -->
            <div class="form-group mt-2">
                <label class="small text-muted">Email</label>
                <InputText class="form-control"
                           @bind-Value="Model.Email"
                           disabled />
            </div>

            <!-- ✅ NEW PASSWORD -->
            <div class="form-group mt-2">
                <label class="small text-muted">New Password</label>
                <InputText class="form-control"
                           type="password"
                           placeholder="Enter a new strong password"
                           @bind-Value="Model.NewPassword" />
                <small class="form-text text-muted">
                    Minimum 6 characters (as per password policy).
                </small>
            </div>

            <!-- ✅ CONFIRM PASSWORD -->
            <div class="form-group mt-2">
                <label class="small text-muted">Confirm New Password</label>
                <InputText class="form-control"
                           type="password"
                           placeholder="Repeat the new password"
                           @bind-Value="Model.ConfirmPassword" />
            </div>

            <div class="d-flex justify-content-end gap-2 mt-4">
                <button type="button"
                        class="btn btn-outline-secondary"
                        @onclick="Cancel">
                    Cancel
                </button>

                <button class="btn btn-primary"
                        disabled="@IsLoading">
                    @(IsLoading ? "Resetting..." : "Reset Password")
                </button>
            </div>
        </EditForm>
    </div>
</div>

@code {

    private ResetModel Model { get; set; } = new ResetModel();
    private bool IsLoading;
    private string? PageMessage;

    protected override void OnInitialized()
    {
        // ✅ READ TOKEN & EMAIL FROM QUERY STRING
        var uri = Navigation.ToAbsoluteUri(Navigation.Uri);
        var qs = QueryHelpers.ParseQuery(uri.Query);

        if (qs.TryGetValue("token", out var token))
            Model.Token = token.ToString();

        if (qs.TryGetValue("email", out var email))
            Model.Email = email.ToString();
    }

    private async Task OnSubmit()
    {
        PageMessage = null;

        // ✅ BASIC VALIDATION
        if (string.IsNullOrWhiteSpace(Model.Token) ||
            string.IsNullOrWhiteSpace(Model.Email))
        {
            PageMessage = "Invalid or expired reset link.";
            return;
        }

        if (Model.NewPassword != Model.ConfirmPassword)
        {
            PageMessage = "Passwords do not match.";
            return;
        }

        if (string.IsNullOrWhiteSpace(Model.NewPassword) ||
            Model.NewPassword.Length < 6)
        {
            PageMessage = "Password must be at least 6 characters.";
            return;
        }

        IsLoading = true;

        try
        {
            // ✅ IMPORTANT:
            // Backend does UrlUnescapeDataString(token)
            // So frontend MUST UrlEncode before sending
            var encodedToken =
                System.Net.WebUtility.UrlEncode(Model.Token);

            var dto = new ResetPasswordDto
            {
                Email = Model.Email,
                Token = encodedToken,
                NewPassword = Model.NewPassword
            };

            await AuthService.ResetPasswordAsync(dto);

            // ✅ AFTER SUCCESS → REDIRECT TO LOGIN
            Navigation.NavigateTo("/login?registered=true");
        }
        catch (Exception ex)
        {
            PageMessage =
                "Failed to reset password. " +
                (ex.Message ?? string.Empty);
        }
        finally
        {
            IsLoading = false;
        }
    }

    private void Cancel()
    {
        Navigation.NavigateTo("/login");
    }

    // ✅ LOCAL VIEW MODEL
    private class ResetModel
    {
        public string Email { get; set; } = string.Empty;
        public string Token { get; set; } = string.Empty;

        [Required]
        public string NewPassword { get; set; } = string.Empty;

        [Required]
        public string ConfirmPassword { get; set; } = string.Empty;
    }
}
