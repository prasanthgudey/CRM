@page "/complete-registration"
@layout AuthLayout

@using CRM.Client.DTOs.Auth
@using CRM.Client.DTOs.Users
@using CRM.Client.Components.Layout
@using CRM.Client.Services.Auth
@using Microsoft.AspNetCore.Components.Forms
@using Microsoft.AspNetCore.WebUtilities
    
@attribute [Authorize]
@using Microsoft.AspNetCore.Authorization
@using Microsoft.JSInterop
@inject AuthService AuthService
@inject NavigationManager Navigation
@inject IJSRuntime JSRuntime      

<h3 class="auth-title">Complete Registration</h3>

@if (!string.IsNullOrWhiteSpace(Message))
{
    <div class="auth-info">
        @Message
    </div>
}

@if (!IsCompleted)
{
    <EditForm Model="RegisterModel" OnValidSubmit="HandleRegistration">
        <DataAnnotationsValidator />

        <div class="form-group">
            <label>Email</label>
            <InputText class="form-control"
                       @bind-Value="RegisterModel.Email" />
        </div>

        <div class="form-group">
            <label>Password</label>
            <InputText type="password"
                       class="form-control"
                       @bind-Value="RegisterModel.Password" />
        </div>

        <button class="btn btn-success w-100"
                disabled="@IsLoading">
            @GetButtonText()
        </button>
    </EditForm>
}

@code {

    private CompleteRegistrationDto RegisterModel { get; set; } = new CompleteRegistrationDto();

    private bool IsLoading { get; set; }

    private bool IsCompleted { get; set; }

    private string? Message { get; set; }

    protected override void OnInitialized()
    {
        var uri = Navigation.ToAbsoluteUri(Navigation.Uri);

        var query = QueryHelpers.ParseQuery(uri.Query);

        if (query.ContainsKey("token"))
        {
            RegisterModel.Token = query["token"];
        }
        else
        {
            Message = "Invalid registration link.";
            IsCompleted = true;
        }

        // optional: if email is also in query
        if (query.ContainsKey("email"))
        {
            RegisterModel.Email = query["email"];
        }
    }

    private async Task HandleRegistration()
    {
        IsLoading = true;
        Message = null;

        try
        {
            // ⭐ new code - use DTO result instead of string
            var result = await AuthService.CompleteRegistrationAsync(RegisterModel);

            if (result == null)
            {
                Message = "Something went wrong.";
                await JSRuntime.InvokeVoidAsync("crmAlerts.showError", "Something went wrong.");
                return;
            }

            if (result.Success)
            {
                // ✅ SweetAlert success
                await JSRuntime.InvokeVoidAsync("crmAlerts.showSuccess", result.Message);

                Message = result.Message;
                IsCompleted = true;

                NavigateToLoginAfterDelay();     // ⭐ this method is defined below
            }
            else
            {
                // ❌ SweetAlert error
                await JSRuntime.InvokeVoidAsync("crmAlerts.showError", result.Message);
                Message = result.Message;
            }
        }
        catch
        {
            Message = "Something went wrong. Please try again.";
            await JSRuntime.InvokeVoidAsync("crmAlerts.showError", "Something went wrong.");
        }
        finally
        {
            IsLoading = false;
        }
    }

    // ⭐ new code - make sure this is INSIDE @code { }
    private async void NavigateToLoginAfterDelay()
    {
        await Task.Delay(2000);
        Navigation.NavigateTo("/login", true);
    }

    private string GetButtonText()
    {
        return IsLoading ? "Processing..." : "Complete Registration";
    }
}
