@page "/mfa-login"
@layout AuthLayout
@attribute [Authorize]
@using Microsoft.AspNetCore.Authorization

@using CRM.Client.Components.Layout
@using CRM.Client.DTOs.Auth
@using CRM.Client.Services.Auth
@using CRM.Client.State
@using Microsoft.AspNetCore.WebUtilities

@inject AuthService AuthService
@inject AppState AppState
@inject NavigationManager Navigation

<h3 class="auth-title">MFA Verification</h3>

@if (!string.IsNullOrWhiteSpace(PageMessage))
{
    <div class="alert alert-info">@PageMessage</div>
}

@if (!string.IsNullOrWhiteSpace(ErrorMessage))
{
    <div class="auth-error">@ErrorMessage</div>
}

<EditForm Model="@Model" OnValidSubmit="HandleVerify">
    <DataAnnotationsValidator />
    <ValidationSummary />

    <div class="form-group">
        <label>Email</label>
        <InputText class="form-control" @bind-Value="Model.Email" disabled />
    </div>

    <div class="form-group">
        <label>6-digit Code</label>
        <InputText class="form-control"
                   maxlength="6"
                   placeholder="123456"
                   @bind-Value="Model.Code" />
    </div>

    <div class="d-flex justify-content-between align-items-center mt-3">
        <button type="button"
                class="btn btn-outline-secondary"
                @onclick="Cancel">
            Cancel
        </button>

        <button type="submit"
                class="btn btn-primary"
                disabled="@IsLoading">
            @(IsLoading ? "Verifying..." : "Verify")
        </button>
    </div>
</EditForm>

@code {

    private MfaLoginDto Model { get; set; } = new();

    private bool IsLoading;

    private string? ErrorMessage;

    private string? PageMessage;

    protected override void OnInitialized()
    {
        // ✅ Read email from query string
        var uri = Navigation.ToAbsoluteUri(Navigation.Uri);
        var qs = QueryHelpers.ParseQuery(uri.Query);

        if (qs.TryGetValue("email", out var email))
            Model.Email = email.ToString();

        if (qs.TryGetValue("msg", out var msg))
            PageMessage = msg.ToString();
    }

    private async Task HandleVerify()
    {
        ErrorMessage = null;
        IsLoading = true;
        StateHasChanged();

        try
        {
            var response = await AuthService.MfaLoginAsync(Model);

            if (response == null)
            {
                ErrorMessage = "Invalid verification code.";
                return;
            }

            RedirectByRole();
        }
        catch (Exception ex)
        {
            ErrorMessage = ex.Message;
        }
        finally
        {
            IsLoading = false;
            StateHasChanged();
        }
    }

    private void RedirectByRole()
    {
        var role = AppState.Auth?.Role;

        if (role == "Admin")
            Navigation.NavigateTo("/admin/users", true);
        else if (role == "Manager")
            Navigation.NavigateTo("/manager", true);
        else
            Navigation.NavigateTo("/user", true);
    }

    private void Cancel()
    {
        Navigation.NavigateTo("/login");
    }
}
