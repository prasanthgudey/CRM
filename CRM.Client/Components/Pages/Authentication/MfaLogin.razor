@page "/mfa-login"
@layout AuthLayout


@using CRM.Client.Components.Layout
@using CRM.Client.DTOs.Auth
@using CRM.Client.Services.Auth
@using CRM.Client.State
@using Microsoft.AspNetCore.WebUtilities

@inject AuthService AuthService
@inject AppState AppState
@inject NavigationManager Navigation
@inject IJSRuntime JSRuntime

<div class="mfa-container">

    <div class="modal-card shadow"
         style="
            width: 540px;
            border-radius: 14px;
            padding: 32px 36px;
            background: white;
            margin-top: 30px;
         ">

        <h4 class="text-center mb-3">MFA Verification</h4>

        @if (!string.IsNullOrWhiteSpace(PageMessage))
        {
            <div class="alert alert-info py-2">@PageMessage</div>
        }

        <EditForm Model="@Model" OnValidSubmit="HandleVerify">
            <DataAnnotationsValidator />

            <!-- Email -->
            <div class="form-group mt-3">
                <label class="small text-muted">Email</label>
                <InputText class="form-control"
                           @bind-Value="Model.Email"
                           disabled />
            </div>

            <!-- 6-digit Code -->
            <div class="form-group mt-3">
                <label class="small text-muted">6-digit Code</label>
                <InputText class="form-control"
                           maxlength="6"
                           placeholder="123456"
                           @bind-Value="Model.Code" />
            </div>

            <!-- BUTTONS -->
            <div class="modal-actions mt-4 d-flex justify-content-end gap-2">
                <button type="button"
                        class="btn btn-outline-secondary"
                        @onclick="Cancel">
                    Cancel
                </button>

                <button class="btn btn-primary"
                        disabled="@IsLoading">
                    @(IsLoading ? "Verifying..." : "Verify")
                </button>
            </div>

        </EditForm>

    </div>

</div>

@code {

    private MfaLoginDto Model { get; set; } = new();

    private bool IsLoading;
    private string? PageMessage;

    protected override void OnInitialized()
    {
        var uri = Navigation.ToAbsoluteUri(Navigation.Uri);
        var qs = QueryHelpers.ParseQuery(uri.Query);

        if (qs.TryGetValue("email", out var email))
            Model.Email = email.ToString();

        if (qs.TryGetValue("msg", out var msg))
            PageMessage = msg.ToString();
    }



    private async Task HandleVerify()
    {
        if (string.IsNullOrWhiteSpace(Model.Code))
        {
            await JSRuntime.InvokeVoidAsync("crmAlerts.showError", "Please enter the 6-digit code");
            return;
        }

        if (Model.Code.Trim().Length != 6)
        {
            await JSRuntime.InvokeVoidAsync("crmAlerts.showError", "The MFA code must be exactly 6 digits");
            return;
        }

        IsLoading = true;

        try
        {
            var response = await AuthService.MfaLoginAsync(Model);

            if (response == null)
            {
                await JSRuntime.InvokeVoidAsync("crmAlerts.showError", "Invalid verification code");
                return;
            }

            RedirectByRole();
        }
        catch (Exception ex)
        {
            await JSRuntime.InvokeVoidAsync("crmAlerts.showError", ex.Message);
        }
        finally
        {
            IsLoading = false;
        }
    }



    private void RedirectByRole()
    {
        var role = AppState.Auth?.Role;

        if (role == "Admin")
            Navigation.NavigateTo("/admin/users", true);
        else if (role == "Manager")
            Navigation.NavigateTo("/manager", true);
        else
            Navigation.NavigateTo("/user", true);
    }

    private void Cancel()
    {
        Navigation.NavigateTo("/login");
    }
}
