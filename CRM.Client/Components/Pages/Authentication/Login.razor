@page "/login"
@layout AuthLayout

@using CRM.Client.Components.Layout
@using CRM.Client.DTOs.Auth
@using CRM.Client.Services.Auth
@using CRM.Client.State
@using Microsoft.AspNetCore.Components.Forms
@using Microsoft.AspNetCore.WebUtilities
@using CRM.Client.Components.Modals.AuthModals

@inject AuthService AuthService
@inject AppState AppState
@inject NavigationManager Navigation
@* @using Microsoft.AspNetCore.WebUtilities *@
@inject NavigationManager Navigation

@if (ShowUnauthorizedMessage)
{
    <div class="auth-alert-overlay">
        <div class="auth-alert-box">
            <span class="auth-alert-text">
                Please login to access the application.
            </span>

            <button class="auth-alert-close"
                    @onclick="CloseUnauthorizedAlert">
                ✕
            </button>
        </div>
    </div>
}




<div class="login-outer-card">

    <div class="login-inner-card">

        <h2 class="login-title">Sign In</h2>
        <p class="login-subtitle">Access your CRM Platform</p>

        <!-- Success alert -->
        @if (QueryHelpers.ParseQuery(Navigation.ToAbsoluteUri(Navigation.Uri).Query)
                .TryGetValue("registered", out var reg))
        {
            <div class="alert alert-success">
                Your password is set. You may now login.
            </div>
        }

        <!-- Error message -->
        @if (!string.IsNullOrWhiteSpace(ErrorMessage))
        {
            <div class="auth-error">@ErrorMessage</div>
        }

        <EditForm Model="@LoginModel" OnValidSubmit="HandleLogin" class="login-form">
            <DataAnnotationsValidator />

            <!-- Email -->
            <div class="form-group">
                <label>Email</label>
                <InputText class="form-control" @bind-Value="LoginModel.Email" />
                <ValidationMessage For="@(() => LoginModel.Email)" />
            </div>

            <!-- Password -->
            <div class="form-group">

                <!-- Password + Forgot link row -->
                <div class="password-row">
                    <label>Password</label>

                    <a class="forgot-link"
                       href="javascript:void(0);"
                       @onclick="OpenForgotPassword">
                        Forgot password?
                    </a>
                </div>

                <InputText class="form-control"
                           @bind-Value="LoginModel.Password"
                           type="password" />
                <ValidationMessage For="@(() => LoginModel.Password)" />
            </div>

            <!-- Login button -->
            <button type="submit" class="login-btn" disabled="@IsLoading">
                @GetButtonText()
            </button>

        </EditForm>

    </div>
</div>

<!-- Forgot password modal -->
<ForgotPasswordModal IsOpen="@IsForgotOpen"
                     OnClose="CloseForgotPasswordModal" />


@code {
    private LoginRequestDto LoginModel { get; set; } = new();
    private bool IsLoading;
    private string? ErrorMessage;

    private bool IsForgotOpen;

    private async Task HandleLogin()
    {
        ErrorMessage = null;
        IsLoading = true;

        try
        {
            var response = await AuthService.LoginAsync(LoginModel);

            if (response == null)
            {
                ErrorMessage = "Invalid email or password.";
                return;
            }

            if (response.MfaRequired)
            {
                var email = Uri.EscapeDataString(response.Email ?? LoginModel.Email ?? "");
                Navigation.NavigateTo($"/mfa-login?email={email}", true);
                return;
            }

            RedirectAfterLogin();
        }
        catch
        {
            ErrorMessage = "Login failed. Please try again.";
        }
        finally
        {
            IsLoading = false;
        }
    }

    private void RedirectAfterLogin()
    {
        Navigation.NavigateTo("/dashboard", true);
    }


    private void RedirectByRole()
    {
        var role = AppState.Auth?.Role;

        Navigation.NavigateTo(role switch
        {
            "Admin" => "/admin/users",
            "Manager" => "/manager",
            _ => "/user"
        }, true);
    }

    private string GetButtonText() => IsLoading ? "Signing in..." : "Login";

    private void OpenForgotPassword() => IsForgotOpen = true;
    private void CloseForgotPasswordModal(bool _) => IsForgotOpen = false;
    private bool ShowUnauthorizedMessage;

    private void CloseUnauthorizedAlert()
    {
        ShowUnauthorizedMessage = false;
    }


    protected override void OnInitialized()
    {
        var uri = Navigation.ToAbsoluteUri(Navigation.Uri);

        if (QueryHelpers.ParseQuery(uri.Query)
            .TryGetValue("reason", out var reason)
            && reason == "unauthorized")
        {
            ShowUnauthorizedMessage = true;
        }

    }
}
