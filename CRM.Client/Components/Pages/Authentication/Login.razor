@page "/login"
@layout AuthLayout

@using CRM.Client.DTOs.Auth
@using CRM.Client.Components.Layout
@using CRM.Client.Services.Auth
@using CRM.Client.State
@using Microsoft.AspNetCore.Components.Forms
@using Microsoft.AspNetCore.Components

@inject AuthService AuthService
@inject AppState AppState
@inject NavigationManager Navigation

<h3 class="auth-title">Sign In</h3>

@if (!string.IsNullOrWhiteSpace(ErrorMessage))
{
    <div class="auth-error">
        @ErrorMessage
    </div>
}

<EditForm Model="@LoginModel" OnValidSubmit="HandleLogin">
    <DataAnnotationsValidator />
    <ValidationSummary />

    <div class="form-group">
        <label>Email</label>
        <InputText @bind-Value="LoginModel.Email"
                   class="form-control"
                   type="email" />
        <ValidationMessage For="@(() => LoginModel.Email)" />
    </div>

    <div class="form-group">
        <label>Password</label>
        <InputText @bind-Value="LoginModel.Password"
                   class="form-control"
                   type="password" />
        <ValidationMessage For="@(() => LoginModel.Password)" />
    </div>

    <button type="submit" class="btn btn-primary w-100" disabled="@IsLoading">
        @GetButtonText()
    </button>
</EditForm>

@code {
    private LoginRequestDto LoginModel { get; set; } = new();

    private bool IsLoading { get; set; }
    private string? ErrorMessage { get; set; }

    private async Task HandleLogin()
    {
        ErrorMessage = null;
        IsLoading = true;
        StateHasChanged();

        Console.WriteLine("===== LOGIN UI DATA CHECK =====");
        Console.WriteLine($"Email   : {LoginModel.Email ?? "NULL"}");
        Console.WriteLine($"Password: {(string.IsNullOrWhiteSpace(LoginModel.Password) ? "EMPTY" : "RECEIVED")}");
        Console.WriteLine("================================");

        try
        {
            var response = await AuthService.LoginAsync(LoginModel);

            Console.WriteLine("===== SERVICE RESPONSE CHECK =====");
            Console.WriteLine(response is null ? "Response is NULL" : "Response RECEIVED");
            Console.WriteLine("===================================");

            if (response == null)
            {
                ErrorMessage = "Invalid email or password.";
                return;
            }

            RedirectByRole();
        }
        catch (Exception ex)
        {
            Console.WriteLine("===== LOGIN EXCEPTION =====");
            Console.WriteLine(ex.Message);
            ErrorMessage = "Login failed due to server error.";
        }
        finally
        {
            IsLoading = false;
            StateHasChanged();
        }
    }

    private void RedirectByRole()
    {
        var role = AppState.Auth?.Role;

        if (role == "Admin")
            Navigation.NavigateTo("/admin/users", true);
        else if (role == "Manager")
            Navigation.NavigateTo("/manager", true);
        else
            Navigation.NavigateTo("/user", true);
    }

    private string GetButtonText() => IsLoading ? "Signing in..." : "Login";
}