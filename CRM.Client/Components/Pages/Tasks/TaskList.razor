@page "/tasks"
@layout MainLayout
@attribute [Authorize]

@using Microsoft.AspNetCore.Authorization
@using Microsoft.AspNetCore.Components.Authorization
@using CRM.Client.DTOs.Tasks
@using CRM.Client.DTOs.Customers
@using CRM.Client.DTOs.Users
@using CRM.Client.Services.Tasks
@using CRM.Client.Services.Customers
@using CRM.Client.Services.Users
@using CRM.Client.Components.Modals.TaskModals
@using CRM.Client.Components.Shared

@inject TaskService TaskService
@inject CustomerService CustomerService
@inject UserService UserService
@inject AuthenticationStateProvider AuthenticationStateProvider

<h3>Tasks</h3>

<div class="mb-3 d-flex gap-2 align-items-center">
    <button class="btn btn-primary" @onclick="OpenCreate">
        + New Task
    </button>
</div>

@if (IsLoading)
{
    <p>Loading tasks...</p>
}
else if (Tasks == null || !Tasks.Any())
{
    <p>No tasks found.</p>
}
else
{
    <table class="table table-bordered align-middle">
        <thead class="table-light">
            <tr>
                <th>Title</th>
                <th>Customer</th>

                @if (IsAdmin)
                {
                    <th>User</th>
                }

                <th role="button" @onclick="@(() => SortByColumn("date"))">
                    Due Date @SortIcon("date")
                </th>

                <th role="button" @onclick="@(() => SortByColumn("priority"))">
                    Priority @SortIcon("priority")
                </th>

                <th role="button" @onclick="@(() => SortByColumn("status"))">
                    Status @SortIcon("status")
                </th>

                <th>Recurring</th>
                <th style="width:200px;">Actions</th>
            </tr>
        </thead>

        <tbody>
            @foreach (var task in Tasks)
            {
                bool isPast = task.DueDate.Date < DateTime.Today;
                bool isCompleted = task.State == TaskState.Completed;

                string rowClass =
                isCompleted ? "task-row-completed" :
                (isPast ? "task-row-overdue" : "");

                <tr class="@rowClass">
                    <td>@task.Title</td>
                    <td>@GetCustomerName(task.CustomerId)</td>

                    @if (IsAdmin)
                    {
                        <td>@GetUserName(task.UserId)</td>
                    }

                    <td>@task.DueDate.ToString("dd MMM yyyy")</td>
                    <td>@task.Priority</td>
                    <td>@task.State</td>

                    <td>
                        @if (task.IsRecurring)
                        {
                            <span class="badge bg-info">
                                @task.RecurrenceType (@task.RecurrenceInterval)
                            </span>
                        }
                        else
                        {
                            <span class="badge bg-secondary">No</span>
                        }
                    </td>

                    <td>
                        <button class="btn btn-light btn-sm me-2"
                                @onclick="() => OpenEdit(task)">
                            Edit
                        </button>

                        <button class="btn btn-danger btn-sm"
                                @onclick="() => OpenDelete(task.TaskId)">
                            Delete
                        </button>
                    </td>
                </tr>
            }
        </tbody>
    </table>

    <Pager CurrentPage="@CurrentPage"
           PageSize="@PageSize"
           TotalCount="@TotalCount"
           OnPageChanged="OnPageChanged" />
}

<CreateTaskModal IsOpen="@IsCreateOpen" OnClose="HandleCreateClosed" />
<EditTaskModal IsOpen="@IsEditOpen" Task="@SelectedTask" OnClose="HandleEditClosed" />
<DeleteTaskModal IsOpen="@IsDeleteOpen" TaskId="@SelectedTaskId" OnClose="HandleDeleteClosed" />

@code {

    // ======================
    // STATE
    // ======================
    private List<TaskResponseDto> Tasks = new();
    private TaskResponseDto? SelectedTask;
    private Guid? SelectedTaskId;

    private bool IsCreateOpen;
    private bool IsEditOpen;
    private bool IsDeleteOpen;

    private bool IsAdmin;

    private int CurrentPage = 1;
    private const int PageSize = 10;
    private long TotalCount;

    private bool IsLoading = true;
    private bool _clamping;

    // SORT
    private string? SortBy;
    private string SortDir = "asc";

    // LOOKUPS
    private Dictionary<Guid, string> CustomerNames = new();
    private Dictionary<string, string> UserNames = new(StringComparer.OrdinalIgnoreCase);

    // ======================
    // LIFECYCLE
    // ======================
    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        if (!firstRender) return;

        var authState = await AuthenticationStateProvider.GetAuthenticationStateAsync();
        IsAdmin = authState.User.IsInRole("Admin");

        await LoadLookups();
        await LoadPage();

        StateHasChanged();
    }

    // ======================
    // SORTING
    // ======================
    private async Task SortByColumn(string column)
    {
        if (SortBy == column)
            SortDir = SortDir == "asc" ? "desc" : "asc";
        else
        {
            SortBy = column;
            SortDir = "asc";
        }

        CurrentPage = 1;
        await LoadPage();
    }

    private MarkupString SortIcon(string column)
    {
        if (SortBy != column)
            return new("");

        return SortDir == "asc"
            ? new MarkupString(" ▲")
            : new MarkupString(" ▼");
    }

    // ======================
    // DATA
    // ======================
    private async Task LoadPage()
    {
        IsLoading = true;
        StateHasChanged();

        var result = await TaskService.GetPagedAsync(
            CurrentPage,
            PageSize,
            search: null,
            sortBy: SortBy,
            sortDir: SortDir);

        if (result == null)
        {
            Tasks = new();
            TotalCount = 0;
            IsLoading = false;
            return;
        }

        if (!_clamping && CurrentPage > result.TotalPages)
        {
            _clamping = true;
            CurrentPage = result.TotalPages;
            await LoadPage();
            _clamping = false;
            return;
        }

        Tasks = result.Items;
        TotalCount = result.TotalCount;
        CurrentPage = result.Page;
        IsLoading = false;
    }

    private async Task OnPageChanged(int page)
    {
        CurrentPage = page;
        await LoadPage();
    }

    // ======================
    // LOOKUPS
    // ======================
    private async Task LoadLookups()
    {
        var customers = await CustomerService.GetAllAsync();
        if (customers != null)
        {
            foreach (var c in customers)
                CustomerNames[c.CustomerId] = $"{c.FirstName} {c.SurName}".Trim();
        }

        var users = await UserService.GetAllUsersAsync();
        if (users != null)
        {
            foreach (var u in users)
                UserNames[u.Id] = string.IsNullOrWhiteSpace(u.FullName)
                    ? u.Email
                    : $"{u.FullName} ({u.Email})";
        }
    }

    private string GetCustomerName(Guid id) =>
        CustomerNames.TryGetValue(id, out var n) ? n : "-";

    private string GetUserName(string id) =>
        UserNames.TryGetValue(id, out var n) ? n : "-";

    // ======================
    // MODALS
    // ======================
    private void OpenCreate() => IsCreateOpen = true;

    private void OpenEdit(TaskResponseDto task)
    {
        SelectedTask = task;
        IsEditOpen = true;
    }

    private void OpenDelete(Guid id)
    {
        SelectedTaskId = id;
        IsDeleteOpen = true;
    }

    private async Task HandleCreateClosed(bool refresh)
    {
        IsCreateOpen = false;
        if (refresh) await LoadPage();
    }

    private async Task HandleEditClosed(bool refresh)
    {
        IsEditOpen = false;
        SelectedTask = null;
        if (refresh) await LoadPage();
    }

    private async Task HandleDeleteClosed(bool refresh)
    {
        IsDeleteOpen = false;
        SelectedTaskId = null;
        if (refresh) await LoadPage();
    }
}