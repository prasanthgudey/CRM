@page "/tasks"
@layout MainLayout

@using CRM.Client.Components.Layout
@using CRM.Client.DTOs.Tasks
@using CRM.Client.DTOs.Shared
@using CRM.Client.Services.Tasks
@using CRM.Client.Services.Users
@using CRM.Client.Services.Customers
@using CRM.Client.Components.Modals.TaskModals
@using CRM.Client.Components.Shared

@inject TaskService TaskService
@inject UserService UserService
@inject CustomerService CustomerService

<h3>Tasks</h3>

<div class="mb-3 d-flex gap-2 align-items-center">
    <button type="button" class="btn btn-primary" @onclick="OpenCreate">+ New Task</button>

    <!-- REMOVED SEARCH FIELD -->
    <!-- PageSize selector -->
    <select class="form-select w-auto ms-2" @bind="PageSize">
        <option value="5">5</option>
        <option value="10">10</option>
        <option value="20">20</option>
        <option value="50">50</option>
    </select>
</div>

@if (IsLoading)
{
    <p>Loading tasks...</p>
}
else if (Tasks == null || !Tasks.Any())
{
    <p>No tasks found.</p>
}
else
{
    <table class="table table-bordered align-middle">
        <thead class="table-light">
            <tr>
                <th>Title</th>
                <th>Customer</th>
                <th>User</th>
                <th>Due Date</th>
                <th>Priority</th>
                <th>Status</th>
                <th>Recurring</th>
                <th style="width:220px">Actions</th>
            </tr>
        </thead>
        <tbody>
            @foreach (var task in Tasks)
            {
                <tr>
                    <td>@task.Title</td>
                    <td>@GetCustomerName(task.CustomerId)</td>
                    <td>@GetUserName(task.UserId)</td>
                    <td>@task.DueDate.ToString("dd MMM yyyy")</td>
                    <td>@task.Priority</td>
                    <td>@task.State</td>

                    <td>
                        @if (task.IsRecurring)
                        {
                            <span class="badge bg-info">@task.RecurrenceType (@task.RecurrenceInterval)</span>
                        }
                        else
                        {
                            <span class="badge bg-secondary">No</span>
                        }
                    </td>

                    <td>
                        <button class="btn btn-light btn-sm me-2" @onclick="() => OpenEdit(task)">Edit</button>
                        <button class="btn btn-danger btn-sm" @onclick="() => OpenDelete(task.TaskId)">Delete</button>
                    </td>
                </tr>
            }
        </tbody>
    </table>

    <Pager CurrentPage="@CurrentPage"
           PageSize="@PageSize"
           TotalCount="@TotalCount"
           OnPageChanged="OnPageChanged" />
}

<CreateTaskModal IsOpen="@IsCreateOpen" OnClose="HandleCreateClosed" />
<EditTaskModal IsOpen="@IsEditOpen" Task="@SelectedTask" OnClose="HandleEditClosed" />
<DeleteTaskModal IsOpen="@IsDeleteOpen" TaskId="@SelectedTaskId" OnClose="HandleDeleteClosed" />

@code {
    private List<TaskResponseDto> Tasks = new();
    private TaskResponseDto? SelectedTask;
    private Guid? SelectedTaskId;

    private bool IsCreateOpen;
    private bool IsEditOpen;
    private bool IsDeleteOpen;

    private int CurrentPage = 1;
    private int _pageSize = 20;
    private long TotalCount = 0;

    private bool IsLoading = true;
    private bool _clamping = false;

    private readonly Dictionary<Guid, string> _customerNames = new();
    private readonly Dictionary<string, string> _userNames = new(StringComparer.OrdinalIgnoreCase);

    private int PageSize
    {
        get => _pageSize;
        set
        {
            if (_pageSize == value) return;
            _pageSize = value;
            CurrentPage = 1;

            _ = InvokeAsync(async () =>
            {
                await LoadPage();
                StateHasChanged();
            });
        }
    }

    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        if (firstRender)
        {
            var customers = await CustomerService.GetAllAsync();
            if (customers != null)
                foreach (var c in customers)
                    _customerNames[c.CustomerId] = $"{c.FirstName} {c.SurName}".Trim();

            var users = await UserService.GetAllUsersAsync();
            if (users != null)
                foreach (var u in users)
                    _userNames[u.Id] = string.IsNullOrWhiteSpace(u.FullName) ? u.Email : $"{u.FullName} ({u.Email})";

            await LoadPage();
            StateHasChanged();
        }
    }

    private string GetCustomerName(Guid customerId)
    {
        if (_customerNames.TryGetValue(customerId, out var name)) return name;
        return customerId == Guid.Empty ? "-" : customerId.ToString();
    }

    private string GetUserName(string? userId)
    {
        if (string.IsNullOrWhiteSpace(userId)) return "-";
        if (_userNames.TryGetValue(userId, out var name)) return name;
        return userId;
    }

    private void OpenCreate() => IsCreateOpen = true;

    private void OpenEdit(TaskResponseDto task)
    {
        SelectedTask = task;
        IsEditOpen = true;
    }

    private void OpenDelete(Guid taskId)
    {
        SelectedTaskId = taskId;
        IsDeleteOpen = true;
    }

    private async Task HandleCreateClosed(bool refresh)
    {
        IsCreateOpen = false;
        if (refresh) await LoadPage();
    }

    private async Task HandleEditClosed(bool refresh)
    {
        IsEditOpen = false;
        SelectedTask = null;
        if (refresh) await LoadPage();
    }

    private async Task HandleDeleteClosed(bool refresh)
    {
        IsDeleteOpen = false;
        SelectedTaskId = null;
        if (refresh) await LoadPage();
    }

    private async Task LoadPage()
    {
        IsLoading = true;
        StateHasChanged();

        // SearchText REMOVED
        var paged = await TaskService.GetPagedAsync(CurrentPage, PageSize);

        if (paged == null)
        {
            Tasks = new();
            TotalCount = 0;
            IsLoading = false;
            return;
        }

        if (!_clamping && paged.TotalPages > 0 && CurrentPage > paged.TotalPages)
        {
            _clamping = true;
            CurrentPage = paged.TotalPages;
            await LoadPage();
            _clamping = false;
            return;
        }

        Tasks = paged.Items;
        TotalCount = paged.TotalCount;
        CurrentPage = paged.Page;
        _pageSize = paged.PageSize;

        IsLoading = false;
    }

    private async Task OnPageChanged(int page)
    {
        CurrentPage = page;
        await LoadPage();
    }
}
