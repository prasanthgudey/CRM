@page "/tasks"
@layout MainLayout

@using CRM.Client.DTOs.Tasks
@using CRM.Client.DTOs.Customers
@using CRM.Client.DTOs.Users
@using CRM.Client.Services.Tasks
@using CRM.Client.Services.Customers
@using CRM.Client.Services.Users
@using CRM.Client.Components.Modals.TaskModals
@using CRM.Client.Components.Shared
@using CRM.Client.Components.Layout

@inject TaskService TaskService
@inject CustomerService CustomerService
@inject UserService UserService

<h3>Tasks</h3>

<div class="mb-3 d-flex gap-2 align-items-center">
    <button class="btn btn-primary" @onclick="OpenCreate">+ New Task</button>
</div>

@if (IsLoading)
{
    <p>Loading tasks...</p>
}
else if (Tasks == null || !Tasks.Any())
{
    <p>No tasks found.</p>
}
else
{
    <table class="table table-bordered align-middle">
        <thead class="table-light">
            <tr>
                <th>Title</th>
                <th>Customer</th>
                <th>User</th>

                <th @onclick='() => SortByColumn("dueDate")' style="cursor:pointer">
                    Due Date
                    @if (SortBy == "dueDate")
                    {
                        <span> (@(SortDir == "desc" ? "↓" : "↑"))</span>
                    }
                </th>

                <th>Priority</th>

                <th @onclick='() => SortByColumn("createdAt")' style="cursor:pointer">
                    Created
                    @if (SortBy == "createdAt")
                    {
                        <span> (@(SortDir == "desc" ? "↓" : "↑"))</span>
                    }
                </th>

                <th>Status</th>
                <th>Recurring</th>
                <th style="width:200px;">Actions</th>
            </tr>
        </thead>
        <tbody>
            @foreach (var task in Tasks)
            {
                bool isPast = task.DueDate.Date < DateTime.Today;

                <tr class="@((isPast ? "table-danger" : ""))">
                    <td>@task.Title</td>
                    <td>@GetCustomerName(task.CustomerId)</td>
                    <td>@GetUserName(task.UserId)</td>
                    <td>@task.DueDate.ToString("dd MMM yyyy")</td>
                    <td>@task.Priority</td>
                    <td>@task.CreatedAt.ToLocalTime().ToString("dd MMM yyyy hh:mm tt")</td>
                    <td>@task.State</td>
                    <td>
                        @if (task.IsRecurring)
                        {
                            <span class="badge bg-info">@task.RecurrenceType (@task.RecurrenceInterval)</span>
                        }
                        else
                        {
                            <span class="badge bg-secondary">No</span>
                        }
                    </td>
                    <td>
                        <button class="btn btn-light btn-sm me-2"
                                @onclick="() => OpenEdit(task)">
                            Edit
                        </button>

                        <button class="btn btn-danger btn-sm"
                                @onclick="() => OpenDelete(task.TaskId)">
                            Delete
                        </button>
                    </td>
                </tr>
            }
        </tbody>
    </table>

    <Pager CurrentPage="@CurrentPage"
           PageSize="10"
           TotalCount="@TotalCount"
           OnPageChanged="OnPageChanged" />
}

<CreateTaskModal IsOpen="@IsCreateOpen" OnClose="HandleCreateClosed" />
<EditTaskModal IsOpen="@IsEditOpen" Task="@SelectedTask" OnClose="HandleEditClosed" />
<DeleteTaskModal IsOpen="@IsDeleteOpen" TaskId="@SelectedTaskId" OnClose="HandleDeleteClosed" />

@code {
    // data
    private List<TaskResponseDto> Tasks = new();
    private TaskResponseDto? SelectedTask;
    private Guid? SelectedTaskId;

    // modals
    private bool IsCreateOpen;
    private bool IsEditOpen;
    private bool IsDeleteOpen;

    // lookup caches
    private readonly Dictionary<Guid, string> _customerNames = new();
    private readonly Dictionary<string, string> _userNames = new(StringComparer.OrdinalIgnoreCase);

    // pagination, search, sort
    private int CurrentPage = 1;
    private const int PageSize = 10;   // 🔥 ALWAYS 10 per page
    private long TotalCount = 0;
    private bool IsLoading = true;
    private bool _clamping = false;

    private Dictionary<Guid, string> CustomerNames = new();
    private Dictionary<string, string> UserNames = new(StringComparer.OrdinalIgnoreCase);

    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        if (firstRender)
        {
            await LoadLookups();
            await LoadPage();
            StateHasChanged();
        }
    }

    private async Task LoadLookups()
    {
        var customers = await CustomerService.GetAllAsync();
        if (customers != null)
            foreach (var c in customers)
                CustomerNames[c.CustomerId] = $"{c.FirstName} {c.SurName}".Trim();

        var users = await UserService.GetAllUsersAsync();
        if (users != null)
            foreach (var u in users)
                UserNames[u.Id] = string.IsNullOrWhiteSpace(u.FullName)
                    ? u.Email
                    : $"{u.FullName} ({u.Email})";
    }

    private string GetCustomerName(Guid id) =>
        CustomerNames.TryGetValue(id, out var n) ? n : "-";

    private string GetUserName(string id) =>
        UserNames.TryGetValue(id, out var n) ? n : "-";

    // --- modals & actions ---
    private void OpenCreate() => IsCreateOpen = true;

    private void OpenEdit(TaskResponseDto t)
    {
        SelectedTask = t;
        IsEditOpen = true;
    }

    private void OpenDelete(Guid id)
    {
        SelectedTaskId = id;
        IsDeleteOpen = true;
    }

    private async Task HandleCreateClosed(bool refresh)
    {
        IsCreateOpen = false;
        if (refresh) await LoadPage();
    }

    private async Task HandleEditClosed(bool refresh)
    {
        IsEditOpen = false;
        SelectedTask = null;
        if (refresh) await LoadPage();
    }

    private async Task HandleDeleteClosed(bool refresh)
    {
        IsDeleteOpen = false;
        SelectedTaskId = null;
        if (refresh) await LoadPage();
    }

    private async Task LoadPage()
    {
        IsLoading = true;
        StateHasChanged();

        var result = await TaskService.GetPagedAsync(CurrentPage, PageSize);

        if (result == null)
        {
            Tasks = new();
            TotalCount = 0;
            IsLoading = false;
            return;
        }

        if (!_clamping && CurrentPage > result.TotalPages)
        {
            _clamping = true;
            CurrentPage = result.TotalPages;
            await LoadPage();
            _clamping = false;
            return;
        }

        Tasks = result.Items;
        TotalCount = result.TotalCount;
        CurrentPage = result.Page;

        IsLoading = false;
    }

    private async Task OnPageChanged(int page)
    {
        CurrentPage = page;
        await LoadPage();
    }
}
