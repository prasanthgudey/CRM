@page "/admin/roles"
@layout MainLayout
@attribute [Authorize]
@using Microsoft.AspNetCore.Authorization

@using CRM.Client.DTOs.Roles
@using CRM.Client.Components.Layout
@using CRM.Client.Components.Shared
@using CRM.Client.Services.Roles
@using CRM.Client.Components.Modals.RoleModals
@inject RoleService RoleService

<h3>Roles Management</h3>

<!-- ✅ ACTION BUTTONS (LIKE USERS PAGE) -->
<div class="mb-3 d-flex gap-2">
    <button class="btn btn-success"
            @onclick="OpenCreateRoleModal">
        Create New Role
    </button>
</div>

@if (!string.IsNullOrWhiteSpace(Message))
{
    <div class="alert alert-info mb-3">
        @Message
    </div>
}

<!-- ✅ ROLES LIST -->
@if (Roles == null)
{
    <p>Loading roles...</p>
}
else
{
    <table class="table table-bordered align-middle">
        <thead class="table-light">
            <tr>
                <th>Role Name</th>
                <th style="width:220px">Actions</th>
            </tr>
        </thead>

        <tbody>
            @foreach (var role in Roles)
            {
                <tr>
                    <td>@role.Name</td>
                    <td>
                        <button type="button"
                                class="btn btn-warning btn-sm me-2"
                                @onclick="() => OpenEditModal(role.Name)">
                            Edit
                        </button>

                        <button type="button"
                                class="btn btn-danger btn-sm"
                                @onclick="() => OpenDeleteModal(role.Name)">
                            Delete
                        </button>
                    </td>
                </tr>
            }
        </tbody>
    </table>
}

<!-- ✅ CREATE ROLE MODAL -->
<CreateRoleModal IsOpen="@IsCreateOpen"
                 OnClose="CloseCreateRoleModal" />


<!-- ✅ EDIT ROLE MODAL -->
<EditRoleModal IsOpen="@IsEditOpen"
               OldRoleName="@SelectedRole"
               OnClose="CloseEditModal" />

<!-- ✅ DELETE ROLE MODAL -->
<DeleteRoleModal IsOpen="@IsDeleteOpen"
                 RoleName="@SelectedRole"
                 OnClose="CloseDeleteModal" />

@code {

    private List<RoleResponseDto>? Roles;

    private string Message = string.Empty;


    private bool IsCreateOpen;
    private bool IsEditOpen;
    private bool IsDeleteOpen;

    private string? SelectedRole;


    // ✅ Load roles
    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        if (firstRender)














        {
            Roles = await RoleService.GetAllRolesAsync();
            StateHasChanged();
        }
    }

    // ✅ CREATE ROLE MODAL
    private void OpenCreateRoleModal()
    {
        IsCreateOpen = true;
    }

    private async Task CloseCreateRoleModal(bool _)
    {
        IsCreateOpen = false;
        Roles = await RoleService.GetAllRolesAsync();
    }

    // ✅ EDIT ROLE MODAL
    private void OpenEditModal(string roleName)
    {
        SelectedRole = roleName;
        IsEditOpen = true;
    }

    private async Task CloseEditModal(bool _)
    {
        IsEditOpen = false;
        SelectedRole = null;
        Roles = await RoleService.GetAllRolesAsync();
    }

    // ✅ DELETE ROLE MODAL
    private void OpenDeleteModal(string roleName)
    {
        SelectedRole = roleName;
        IsDeleteOpen = true;
    }

    private async Task CloseDeleteModal(bool _)
    {
        IsDeleteOpen = false;
        SelectedRole = null;
        Roles = await RoleService.GetAllRolesAsync();
    }
}
