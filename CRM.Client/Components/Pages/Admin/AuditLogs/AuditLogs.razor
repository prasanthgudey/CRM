@page "/admin/audit-log"
@layout MainLayout
@attribute [Authorize(Roles = "Admin")]

@using Microsoft.AspNetCore.Authorization
@using System.Text.Json
@using CRM.Client.Components.Layout
@using CRM.Client.Components.Modals.CustomerModals
@using CRM.Client.Components.Modals.RoleModals
@using CRM.Client.Components.Modals.TaskModals
@using CRM.Client.Components.Modals.UserModals
@using CRM.Client.DTOs.Audit
@using CRM.Client.DTOs.Customers
@using CRM.Client.DTOs.Tasks
@using CRM.Client.DTOs.Users
@using CRM.Client.DTOs.Roles
@using CRM.Client.Services.Audit
@using CRM.Client.Services.Users

@inject AuditService AuditService
@inject UserService UserService

<h3>Audit Log</h3>

@if (Logs == null)
{
    <p>Loading audit logs...</p>
}
else
{
    <div class="table-responsive">
        <table class="table table-bordered table-hover align-middle">
            <thead class="table-light">
                <tr>
                    <th>Date</th>
                    <th>Action</th>
                    <th>Entity</th>
                    <th>Performed By</th>
                    <th>Target</th>
                    <th>Status</th>
                    <th>Old</th>
                    <th>New</th>
                </tr>
            </thead>

            <tbody>
                @foreach (var log in Logs)
                {
                    <tr>
                        <td>@log.CreatedAt.ToLocalTime().ToString("dd MMM yyyy HH:mm")</td>

                        <td><span class="fw-semibold">@log.Action</span></td>

                        <td><span class="badge bg-info">@log.EntityName</span></td>

                        <td>
                            @if (!string.IsNullOrWhiteSpace(log.PerformedByUserName))
                            {
                                <span class="audit-user"
                                      title="@log.PerformedByUserName"
                                      @onclick="() => OpenUserViewModal(log.PerformedByUserId)">
                                    @log.PerformedByUserName
                                </span>
                            }
                            else
                            {
                                <span>-</span>
                            }
                        </td>

                        <td>
                            @if (!string.IsNullOrWhiteSpace(log.TargetUserName))
                            {
                                <span class="audit-user"
                                      title="@log.TargetUserName"
                                      @onclick="() => OpenUserViewModal(log.TargetUserId)">
                                    @log.TargetUserName
                                </span>
                            }
                            else
                            {
                                <span>-</span>
                            }
                        </td>

                        <td>
                            @if (log.IsSuccess)
                            {
                                <span class="badge bg-success">Success</span>
                            }
                            else
                            {
                                <span class="badge bg-danger">Failed</span>
                            }
                        </td>

                        <!-- OLD value cell: opens entity-specific view modal -->
                        <td> @if (!string.IsNullOrWhiteSpace(log.OldValue)) {
                        <button class="btn btn-outline-secondary btn-sm audit-eye-btn" title="@($"{log.EntityName} - Old")"
                        @onclick="() => OpenEntityViewModal(log, true)"> 
                       <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" 
                        fill="currentColor" viewBox="0 0 16 16"> 
                        <path d="M16 8s-3-5.5-8-5.5S0 8 0 8s3 5.5 8 5.5S16 8 16 8z" /> 
                        <path d="M8 5.5a2.5 2.5 0 1 1 0 5 2.5 2.5 0 0 1 0-5z" /> 
                      </svg> 
                      <span class="ms-1 small">Old</span> </button>
                    } else
                    {

                        <span>-</span>
                    }
                     </td> <!-- NEW value cell: opens entity-specific view modal -->
                    <td> @if (!string.IsNullOrWhiteSpace(log.NewValue)) {
                    <button class="btn btn-outline-primary btn-sm audit-eye-btn" title="@($"{log.EntityName} - New")" 
                    @onclick="() => OpenEntityViewModal(log, false)"> 
                    <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" 
                    fill="currentColor" viewBox="0 0 16 16"> 
                    <path d="M16 8s-3-5.5-8-5.5S0 8 0 8s3 5.5 8 5.5S16 8 16 8z" /> 
                    <path d="M8 5.5a2.5 2.5 0 1 1 0 5 2.5 2.5 0 0 1 0-5z" />
                </svg> <span class="ms-1 small">New</span> </button>
                } else
                {

                    <span>-</span>
                }
 </td>
                    </tr>
                }
            </tbody>
        </table>
    </div>
}

<!-- =======================
     VIEW MODALS
======================= -->

<ViewCustomerModal IsOpen="@isViewCustomerOpen"
                   Model="@customerViewModel"
                   OnClose="OnCustomerModalClosed" />

<ViewTaskModal IsOpen="@isViewTaskOpen"
               Model="@taskViewModel"
               OnClose="OnTaskModalClosed" />

<ViewUserModal IsOpen="@isViewUserOpen"
               Model="@userViewModel"
               OnClose="OnUserModalClosed" />

<ViewRoleModal IsOpen="@isViewRoleOpen"
               Model="@roleViewModel"
               OnClose="OnRoleModalClosed" />

@code {
    private List<AuditLogResponseDto>? Logs;

    private bool isViewCustomerOpen;
    private CustomerResponseDto? customerViewModel;

    private bool isViewTaskOpen;
    private TaskResponseDto? taskViewModel;

    private bool isViewUserOpen;
    private UserResponseDto? userViewModel;

    private bool isViewRoleOpen;
    private RoleResponseDto? roleViewModel;

    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        if (firstRender)
        {
            Logs = await AuditService.GetAllAsync();
            StateHasChanged();
        }
    }

    // ✅ OPEN USER MODAL (Performed By / Target)
    private async Task OpenUserViewModal(string? userId)
    {
        if (string.IsNullOrWhiteSpace(userId))
            return;

        userViewModel = await UserService.GetUserByIdAsync(userId);
        isViewUserOpen = userViewModel != null;

        StateHasChanged();
    }

    // ✅ ENTITY MODALS (Old / New)
    private void OpenEntityViewModal(AuditLogResponseDto log, bool useOld)
    {
        var json = useOld ? log.OldValue : log.NewValue;
        if (string.IsNullOrWhiteSpace(json)) return;

        CloseAllViewModels();

        var entity = (log.EntityName ?? "").ToLowerInvariant();
        var options = new JsonSerializerOptions { PropertyNameCaseInsensitive = true };

        if (entity.Contains("task"))
        {
            taskViewModel = JsonSerializer.Deserialize<TaskResponseDto>(json, options);
            isViewTaskOpen = taskViewModel != null;
        }
        else if (entity.Contains("customer"))
        {
            customerViewModel = JsonSerializer.Deserialize<CustomerResponseDto>(json, options);
            isViewCustomerOpen = customerViewModel != null;
        }
        else if (entity.Contains("user"))
        {
            userViewModel = JsonSerializer.Deserialize<UserResponseDto>(json, options);
            isViewUserOpen = userViewModel != null;
        }
        else if (entity.Contains("role"))
        {
            roleViewModel = JsonSerializer.Deserialize<RoleResponseDto>(json, options);
            isViewRoleOpen = roleViewModel != null;
        }

        StateHasChanged();
    }

    private void CloseAllViewModels()
    {
        isViewCustomerOpen = false;
        isViewTaskOpen = false;
        isViewUserOpen = false;
        isViewRoleOpen = false;

        customerViewModel = null;
        taskViewModel = null;
        userViewModel = null;
        roleViewModel = null;
    }

    private Task OnCustomerModalClosed(bool _) { isViewCustomerOpen = false; return Task.CompletedTask; }
    private Task OnTaskModalClosed(bool _) { isViewTaskOpen = false; return Task.CompletedTask; }
    private Task OnUserModalClosed(bool _) { isViewUserOpen = false; return Task.CompletedTask; }
    private Task OnRoleModalClosed(bool _) { isViewRoleOpen = false; return Task.CompletedTask; }
}


<style>
    .audit-json {
        max-width: 250px;
        max-height: 80px;
        overflow: auto;
        background: #f8f9fa;
        padding: 6px;
        font-size: 11px;
        border-radius: 6px;
    }

    .audit-user {
        color: #0d6efd;
        cursor: pointer;
        font-weight: 500;
        text-decoration: underline;
    }

    .audit-user:hover {
        color: #084298;
    }

    /* make the eye buttons compact and aligned */
    .audit-eye-btn {
        display: inline-flex;
        align-items: center;
        gap: .35rem;
    }

    /* optional: keep table button width tidy */
    .table .btn-sm { min-width: 60px; }
</style>
