@page "/Error"
@using System.Diagnostics
@inject NavigationManager Navigation

<PageTitle>Error</PageTitle>

<h1 class="text-danger">Error.</h1>
<h2 class="text-danger">An error occurred while processing your request.</h2>

@if (ShowRequestId)
{
    <p>
        <strong>Request ID:</strong> <code>@RequestId</code>
    </p>
}

<h3>Development Mode</h3>
<p>
    Swapping to <strong>Development</strong> environment will display more detailed information about the error that occurred.
</p>
<p>
    <strong>The Development environment shouldn't be enabled for deployed applications.</strong>
    It can result in displaying sensitive information from exceptions to end users.
    For local debugging, enable the <strong>Development</strong> environment by setting the <strong>ASPNETCORE_ENVIRONMENT</strong> environment variable to <strong>Development</strong>
    and restarting the app.
</p>

@code {
    private string? RequestId { get; set; }
    private bool ShowRequestId => !string.IsNullOrEmpty(RequestId);

    protected override void OnInitialized()
    {
        // Try 1: requestId from query string (e.g. /Error?requestId=abc)
        var uri = Navigation.ToAbsoluteUri(Navigation.Uri);
        var query = uri.Query; // like "?requestId=abc"
        if (!string.IsNullOrEmpty(query))
        {
            RequestId = ParseQueryStringValue(query, "requestId");
        }

        // Try 2: fallback to Activity.Current if present (may be null in WASM)
        if (string.IsNullOrEmpty(RequestId))
        {
            RequestId = Activity.Current?.Id;
        }
    }

    // Minimal query-string parser (no extra packages required)
    private static string? ParseQueryStringValue(string query, string key)
    {
        // query expected like "?a=1&b=2"
        if (string.IsNullOrEmpty(query) || string.IsNullOrEmpty(key))
            return null;

        var trimmed = query.StartsWith("?") ? query.Substring(1) : query;
        var pairs = trimmed.Split('&', StringSplitOptions.RemoveEmptyEntries);

        foreach (var pair in pairs)
        {
            var idx = pair.IndexOf('=');
            if (idx <= 0) continue;

            var k = Uri.UnescapeDataString(pair.Substring(0, idx));
            if (!string.Equals(k, key, StringComparison.OrdinalIgnoreCase)) continue;

            var v = pair.Length > idx + 1 ? Uri.UnescapeDataString(pair.Substring(idx + 1)) : string.Empty;
            return v;
        }

        return null;
    }
}
