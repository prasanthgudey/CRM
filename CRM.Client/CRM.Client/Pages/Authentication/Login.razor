@page "/login"
@layout AuthLayout

@using CRM.Client.DTOs.Auth
@using CRM.Client.Layout
@using CRM.Client.Services.Auth
@using CRM.Client.State
@using Microsoft.AspNetCore.Components.Forms
@inject AuthService AuthService
@inject AppState AppState
@inject NavigationManager Navigation

<h3 class="auth-title">Sign In</h3>

@if (!string.IsNullOrWhiteSpace(ErrorMessage))
{
    <div class="auth-error">
        @ErrorMessage
    </div>
}

<EditForm Model="LoginModel" OnValidSubmit="HandleLogin" FormName="login-form">
    <DataAnnotationsValidator />

    <div class="form-group">
        <label>Email</label>
        <InputText class="form-control"
                   @bind-Value="LoginModel.Email" />
        <ValidationMessage For="@(() => LoginModel.Email)" />
    </div>

    <div class="form-group">
        <label>Password</label>
        <InputText type="password"
                   class="form-control"
                   @bind-Value="LoginModel.Password" />
        <ValidationMessage For="@(() => LoginModel.Password)" />
    </div>

    <button class="btn btn-primary w-100"
            disabled="@IsLoading">
        @GetButtonText()
    </button>
</EditForm>


@code {

    private LoginRequestDto LoginModel { get; set; } = new LoginRequestDto();

    private bool IsLoading { get; set; }

    private string? ErrorMessage { get; set; }

    private async Task HandleLogin()
    {
        ErrorMessage = null;
        IsLoading = true;

        try
        {
            var response = await AuthService.LoginAsync(LoginModel);

            if (response == null)
            {
                ErrorMessage = "Invalid credentials. Please try again.";
                return;
            }

            RedirectByRole();
        }
        catch
        {
            ErrorMessage = "Login failed. Please try again later.";
        }
        finally
        {
            IsLoading = false;
        }
    }

    private void RedirectByRole()
    {
        var role = AppState.Auth.Role;

        if (role == "Admin")
        {
            Navigation.NavigateTo("/admin/users", true);
            return;
        }

        if (role == "Manager")
        {
            Navigation.NavigateTo("/manager", true);
            return;
        }

        Navigation.NavigateTo("/user", true);
    }

    private string GetButtonText()
    {
        return IsLoading ? "Signing in..." : "Login";
    }
}
